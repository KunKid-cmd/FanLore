{% extends "base.html" %}

{% block content %}
<div class="content-container">
    <!-- Left side: Main Content -->
    <div class="content-left">
        <h1>{{ content.title }}</h1>
                <!-- The Bookmark Button -->
        <button id="bookmark-toggle" class="btn btn-light" data-content-id="{{ content.id }}">
            <i class="fas fa-bookmark"></i>
        </button>

        <script>
            document.getElementById('bookmark-toggle').addEventListener('click', function() {
                var contentId = this.getAttribute('data-content-id');

                // Add CSRF token to the header
                var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                fetch("{% url 'toggle_bookmark' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken
                    },
                    body: JSON.stringify({ "content_id": contentId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.bookmarked) {
                        this.innerHTML = '<i class="fas fa-bookmark"></i> Bookmarked';
                        alert('Post bookmarked!');
                    } else {
                        this.innerHTML = '<i class="far fa-bookmark"></i> Bookmark';
                        alert('Bookmark removed!');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                });
            });
        </script>
        <p class="meta">
            {{ content.time_since_creation }} by <span class="author">{{ content.collaborator.username }}</span>
        </p>

        {% if content.topic_img %}
            <img class="content-image" src="{{ content.topic_img.url }}" alt="{{ content.title }}">
        {% endif %}

        <p class="description">{{ content.description }}</p>

        <!-- Display Content Files -->
        <div class="content-files">
            <h3>Attached Files</h3>
            {% if content.attached_files.all %}
                <div class="file-grid">
                    {% for file in content.attached_files.all %}
                        <div class="file-card">
                            <a href="{{ file.file }}" target="_blank" class="file-link">
                                <div class="file-icon">
                                    <i class="fas fa-file"></i>
                                </div>
                                <div class="file-name">
                                    {{ file.file|slice:"40" }}{% if file.file|length > 40 %}...{% endif %}
                                </div>
                            </a>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p>No files attached.</p>
            {% endif %}
        </div>

        <!-- Comments Section -->
        <div class="comment-section">
            <h3>{{ comments.count }} Comment{% if comments.count != 1 %}s{% endif %}</h3>
            <ul class="comment-list">
                {% for comment in comments %}
                    <li class="comment">
                        <div class="comment-header">
                            <!-- Display profile image if available -->
                            <img src="{{ comment.user_profile_image }}" alt="{{ comment.commentator_name }}'s profile" class="comment-avatar">
                            <strong class="commentator-name">{{ comment.commentator_name }}</strong>
                            <span class="comment-time">{{ comment.time_since_comment }}</span>
                        </div>
                        <p class="comment-text">{{ comment.comment_text }}</p>
                    </li>
                {% empty %}
                    <li>No comments yet.</li>
                {% endfor %}
            </ul>
        </div>


        <!-- Comment Form -->
        {% if user.is_authenticated %}
        <form method="post" class="comment-form">
            {% csrf_token %}
            <label for="{{ form.comment_text.id_for_label }}">Comment</label>
            {{ form.comment_text }}
            <button type="submit">Comment</button>
        </form>
        {% else %}
            <p>Please log in to comment.</p>
        {% endif %}
    </div>

    <!-- Right side: Stats & Contributors -->
    <div class="content-right">
        {% if user == content.collaborator %}
            <a href="{% url 'content_edit' content.id %}" class="edit-button">Edit Content</a>
        {% endif %}

        <div class="stats">
            <p><strong>{{ content.views }} Views</strong></p>
            <p><strong>{{ content.vote }} Up Vote</strong></p>
            <p><strong>{{ content.shares }} Share</strong></p>
        </div>

        <div class="tags">
            {% for tag in content.tags.all %}
                <span class="tag">#{{ tag.name }}</span>
            {% endfor %}
        </div>

        <div class="contributors">
            <h4>Contributor:</h4>
            {% for contributor in content.contributors.all %}
                <div class="contributor">
                    <img src="{{ contributor.profile_img.url }}" alt="{{ contributor.username }}" class="avatar">
                    <span>{{ contributor.username }}</span>
                </div>
            {% endfor %}
        </div>

        <button class="vote-button">⬆️ Up Vote to this content</button>

        <div class="posting-rules">
            <h4>Posting Rules</h4>
            <p><strong>1. Submissions must be verifiable.</strong> Please link directly to a reliable source that supports your claim.</p>
            <p><strong>2. No personal opinions, anecdotes, or subjective statements.</strong></p>
            <p><strong>3. No recent sources.</strong> Any source less than two months old is not allowed.</p>
        </div>
    </div>
</div>

<style>
    .content-container {
        display: flex;
        gap: 20px;
    }
    .content-left {
        width: 65%;
    }
    .content-left h1 {
        font-size: 2em;
        margin-bottom: 5px;
    }
    .meta {
        color: gray;
        font-size: 0.9em;
    }
    .author {
        color: red;
    }
    .content-image {
        width: 100%;
        max-height: 400px;
        object-fit: cover;
        border-radius: 10px;
    }
    .description {
        font-size: 1.1em;
        margin-top: 10px;
    }
    .comment-section {
        margin-top: 15px;
    }
    .comment {
        border-bottom: 1px solid #ddd;
        padding: 10px 0;
    }

    .comment-form {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }

    .comment-form label {
        font-weight: bold;
    }

    .comment-form textarea {
        width: 100%;
        max-width: 500px;
        height: 120px;
        font-size: 14px;
        padding: 8px;
        border-radius: 5px;
        border: 1px solid #ccc;
        resize: vertical;
    }

    .comment-form button {
        background-color: #d9534f;
        color: white;
        border: none;
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 5px;
        margin-top: 5px;
    }

    .comment-form button:hover {
        background-color: #c9302c;
    }

    .comment-header {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .comment-list {
        list-style-type: none; /* Remove bullet points */
        padding: 0;
        margin: 0;
    }


    .comment-avatar {
        width: 30px; /* Smaller size */
        height: 30px; /* Smaller size */
        border-radius: 50%;
        object-fit: cover;
    }

    .commentator-name {
        font-weight: bold;
    }

    .content-right {
        width: 35%;
        background: #f8f8f8;
        padding: 15px;
        border-radius: 10px;
    }
    .stats p {
        font-size: 1.2em;
        margin: 5px 0;
    }
    .tags {
        margin-top: 10px;
    }
    .tag {
        background: #ddd;
        padding: 5px;
        border-radius: 5px;
        margin-right: 5px;
        font-size: 0.9em;
    }
    .contributors {
        margin-top: 15px;
    }
    .contributor {
        display: flex;
        align-items: center;
        margin-top: 5px;
    }
    .avatar {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        margin-right: 10px;
    }
    .vote-button {
        background: red;
        color: white;
        padding: 10px;
        width: 100%;
        margin-top: 10px;
        border: none;
        cursor: pointer;
        font-size: 1em;
    }
    .posting-rules {
        margin-top: 20px;
        font-size: 0.9em;
    }

    /* Styles for Content Files */
    .content-files {
        margin-top: 20px;
        margin-bottom: 20px;
    }
    .file-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
    }
    .file-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 10px;
        text-align: center;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .file-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .file-icon {
        font-size: 2em;
        color: #666;
    }
    .file-name {
        margin-top: 10px;
        font-size: 0.9em;
        color: #333;
        word-break: break-word;
    }
    .file-link {
        text-decoration: none;
        color: inherit;
    }
    .file-image {
        width: 100%;
        max-height: 150px;
        object-fit: cover;
        border-radius: 5px;
        margin-top: 10px;
    }
</style>

{% endblock %}